  <!-- index.html (actualizado para SPA) -->
  <!DOCTYPE html>
  <html lang="es">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
    <title>Crypto2025</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" />

    <script src="https://cdn.tailwindcss.com"></script>
  </head>
  <body class="bg-gray-100 min-h-screen flex items-center justify-center">

    <div class="bg-white shadow-xl rounded-xl w-full max-w-6xl flex overflow-hidden">
      
      <!-- Sidebar -->
      <aside class="bg-purple-700 text-white w-64 p-6 flex-shrink-0">
<h2 id="bienvenidaUsuario" class="text-xl font-bold mb-6">üëã  Bienvenido</h2>
        <nav class="space-y-4">
          <div>
            <h3 class="text-sm uppercase tracking-wide font-semibold text-purple-200 mb-2">Datos Cripto</h3>
            <button onclick="loadContent('clasica')" class="block text-left w-full hover:underline">‚Ä¢ Criptograf√≠a Cl√°sica</button>
            <button onclick="loadContent('moderna')" class="block text-left w-full hover:underline">‚Ä¢ Criptograf√≠a Moderna</button>
            <button onclick="loadContent('tendencias')" class="block text-left w-full hover:underline">‚Ä¢ Tendencias Criptogr√°ficas</button>
          </div>
          <div>
            <h3 class="text-sm uppercase tracking-wide font-semibold text-purple-200 mt-6 mb-2">Recursos</h3>
            <button onclick="loadContent('sobremi')" class="block text-left w-full hover:underline">‚Ä¢ Sobre m√≠</button>
            <button onclick="loadContent('rsa')" class="block text-left w-full hover:underline">‚Ä¢ RSA</button>
            <button onclick="loadContent('rsa_hibrido')" class="block text-left w-full hover:underline">‚Ä¢ RSA Hibrido</button>


          </div>
        </nav>
      </aside>

      <!-- Main -->
      <main class="flex-1 p-8 bg-gray-50 overflow-y-auto" id="mainContent">
        <!-- Este contenido cambiar√° din√°micamente -->
      </main>
    </div>

    <!-- Scripts -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/crypto-js/4.1.1/crypto-js.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script>
      function encryptText() {
        const text = document.getElementById("textInput").value;
        const encrypted = CryptoJS.AES.encrypt(text, "clave-secreta").toString();
        document.getElementById("outputText").value = encrypted;
      }

      function decryptText() {
        const encrypted = document.getElementById("outputText").value;
        try {
          const decrypted = CryptoJS.AES.decrypt(encrypted, "clave-secreta").toString(CryptoJS.enc.Utf8);
          document.getElementById("outputText").value = decrypted;
        } catch {
          alert("‚ö†Ô∏è Error al descifrar el texto.");
        }
      }

  async function generatePDF() {
    const { jsPDF } = window.jspdf;
    const doc = new jsPDF({
      orientation: "portrait",
      unit: "mm",
      format: "a4"
    });

    const mainContent = document.getElementById("mainContent");
    const outputArea = document.getElementById("outputText");

    let title = "";
    let content = "";

    // Si hay campo de resultado (secci√≥n herramientas), usa eso
    if (outputArea) {
      title = "Resultado Criptogr√°fico";
      content = outputArea.value || "Sin contenido";
    } else {
      // Si es una secci√≥n normal (cl√°sica, moderna, etc.)
      const heading = mainContent.querySelector("h1, h2");
  title = heading?.textContent?.replace(/^[^\w\d]+/, "").trim() || "CryptoTools";

      // Recorrer el contenido y construir texto limpio
      content = "";
      mainContent.querySelectorAll("p, li").forEach(el => {
        const text = el.textContent.trim();
        if (el.tagName === "LI") {
          content += `‚Ä¢ ${text}\n`;
        } else {
          content += `${text}\n\n`;
        }
      });
    }

    // Limpiar caracteres raros y saltos m√∫ltiples
    content = content
      .replace(/[^\x20-\x7E√Å√â√ç√ì√ö√°√©√≠√≥√∫√±√ë√º√ú¬ø¬°\n\r‚Ä¢]/g, "")
      .replace(/\n{3,}/g, "\n\n");

    // Configuraci√≥n
    const leftMargin = 20;
    const rightMargin = 190;
    const lineHeight = 7;
    let y = 30;

    // T√≠tulo centrado
    doc.setFont("helvetica", "bold");
    doc.setFontSize(18);
    doc.text(title, 105, 20, { align: "center" });

    // Cuerpo del contenido justificado
    doc.setFont("times", "normal");
    doc.setFontSize(12);
    const lines = doc.splitTextToSize(content, rightMargin - leftMargin);
    lines.forEach(line => {
      if (y >= 280) {
        doc.addPage();
        y = 20;
      }
      doc.text(line, leftMargin, y);
      y += lineHeight;
    });

    // Pie de p√°gina con autor y fecha
    doc.setFontSize(10);
    doc.setTextColor(100);
    doc.text("Generado por Yoseph - CryptoTools", leftMargin, 290);
    doc.text(new Date().toLocaleDateString(), 170, 290);

    // Guardar con nombre claro
    const filename = title.toLowerCase().replace(/[^\w\s]/gi, "").replace(/\s+/g, "_") + ".pdf";
    doc.save(filename);
  }



      function loadContent(section) {
        const main = document.getElementById("mainContent");
        switch (section) {
case 'clasica':
  main.innerHTML = `
    <h1 class="text-3xl font-bold mb-4">Criptograf√≠a Cl√°sica</h1>
    <p class="mb-4">
      La criptograf√≠a cl√°sica es el arte del cifrado antes de la era computacional. Estas t√©cnicas, aunque obsoletas en t√©rminos de seguridad actual, sentaron las bases del cifrado moderno.
    </p>

    <h2 class="text-xl font-semibold mb-2">Caracter√≠sticas Principales:</h2>
    <ul class="list-disc list-inside mb-4 space-y-1">
      <li>Uso de l√°piz y papel o dispositivos mec√°nicos simples</li>
      <li>No depende de claves p√∫blicas o privadas modernas</li>
      <li>F√°cil de implementar, pero vulnerable a an√°lisis estad√≠stico</li>
    </ul>

    <h2 class="text-xl font-semibold mb-2">Ejemplos Populares:</h2>
    <ul class="list-disc list-inside mb-4 space-y-1">
      <li><strong>Cifrado C√©sar:</strong> Desplazamiento de letras en el alfabeto</li>
      <li><strong>Atbash:</strong> Inversi√≥n total del alfabeto</li>
      <li><strong>Vigen√®re:</strong> Uso de una palabra clave como patr√≥n</li>
      <li><strong>M√°quina Enigma:</strong> Usada por los nazis en la Segunda Guerra Mundial</li>
    </ul>

    <p class="mb-4">
      Estos sistemas permitieron mantener secretos militares y pol√≠ticos durante siglos. Aunque son simples, muchos de ellos siguen ense√±√°ndose por su valor pedag√≥gico.
    </p>

    <div class="text-center">
      <button onclick="generatePDF()" class="bg-gray-800 text-white px-6 py-2 rounded">Guardar como PDF</button>
    </div>
  `;
  break;

          case 'moderna':
  main.innerHTML = `
    <h1 class="text-3xl font-bold mb-4">Criptograf√≠a Moderna</h1>
    <p class="mb-4">
      La criptograf√≠a moderna se basa en principios matem√°ticos como la teor√≠a de n√∫meros, √°lgebra abstracta y funciones hash. Permite asegurar comunicaciones, identidades y transacciones digitales.
    </p>

    <h2 class="text-xl font-semibold mb-2">Algoritmos Relevantes:</h2>
    <ul class="list-disc list-inside mb-4 space-y-1">
      <li><strong>AES (Advanced Encryption Standard):</strong> Cifrado sim√©trico r√°pido y robusto</li>
      <li><strong>RSA:</strong> Cifrado asim√©trico basado en la dificultad de factorizar n√∫meros grandes</li>
      <li><strong>SHA-256:</strong> Funci√≥n hash usada ampliamente en blockchain</li>
      <li><strong>ECC (Elliptic Curve Cryptography):</strong> Seguridad fuerte con claves m√°s peque√±as</li>
    </ul>

    <h2 class="text-xl font-semibold mb-2">Aplicaciones Pr√°cticas:</h2>
    <ul class="list-disc list-inside mb-4 space-y-1">
      <li>Protecci√≥n de correos electr√≥nicos (PGP)</li>
      <li>Firmas digitales y certificados SSL</li>
      <li>Blockchain y criptomonedas</li>
      <li>Autenticaci√≥n en dos pasos y tokens de acceso</li>
    </ul>

    <div class="text-center">
      <button onclick="generatePDF()" class="bg-gray-800 text-white px-6 py-2 rounded">Generar PDF</button>
    </div>
  `;
  break;

         case 'tendencias':
  main.innerHTML = `
    <h1 class="text-3xl font-bold mb-4">Tendencias Criptogr√°ficas</h1>
    <p class="mb-4">
      La criptograf√≠a no deja de evolucionar. Nuevas amenazas, como la computaci√≥n cu√°ntica, exigen soluciones innovadoras. Aqu√≠ algunas de las tendencias m√°s destacadas:
    </p>

    <ul class="list-disc list-inside mb-4 space-y-1">
      <li><strong>Criptograf√≠a poscu√°ntica:</strong> Algoritmos resistentes a la computaci√≥n cu√°ntica</li>
      <li><strong>Zero-Knowledge Proofs (ZKP):</strong> Demostrar conocimiento sin revelar informaci√≥n</li>
      <li><strong>Homomorphic Encryption:</strong> Procesar datos cifrados sin descifrarlos</li>
      <li><strong>Blockchain y contratos inteligentes:</strong> Seguridad descentralizada</li>
      <li><strong>Criptograf√≠a basada en identidad (IBE):</strong> Sustituye certificados digitales tradicionales</li>
    </ul>

    <p class="mb-4">
      Estas innovaciones est√°n redefiniendo c√≥mo protegemos la privacidad y la integridad de la informaci√≥n en el mundo digital.
    </p>

    <div class="text-center">
      <button onclick="generatePDF()" class="bg-gray-800 text-white px-6 py-2 rounded">Generar PDF</button>
    </div>
  `;
  break;

          case 'sobremi':
  main.innerHTML = `
        <div class="flex flex-col sm:flex-row items-center gap-6 mb-6">
        <img src="perfil.jpg" alt="Foto de Yoseph" class="w-32 h-32 rounded-md object-cover shadow-md border-2">
          <div>
            <p class="text-lg font-medium mb-2">Hola, soy Yoseph. Loco, raro, uno mas ... O menos si mi cabeza sigue asi xd.</p>
            <ul class="list-disc list-inside text-gray-700">
              <li>Estudiante de Ingenier√≠a en Sistemas Computacionales en ESCOM</li>
              <li>Escribo y aprendo por diversion y terapia</li>
              <li>Adicto al sufrimiento y el autosabotaje</li>
            </ul>
          </div>
        </div>

    <p class="mt-4 text-gray-800">
      <strong>Trayectoria acad√©mica:</strong> 
        <ul class="list-disc list-inside text-gray-700">
          <li>Escuela Secundaria General Federalizada "Texcoco 211"</li>
          <li>Centro de Estudios Cientificos y Tecnologicos No. 10 "Carlos Vallejo Marquez, IPN"</li>
          <li>Escuela Superior de Computo ESCOM, IPN</li>
        </ul>
    </p>
      <br>
  </p>


    <p class="mt-4 text-gray-800">
      <strong>Curiosidades Criptograficas:</strong> 
        <ul class="list-disc list-inside text-gray-700">
          <li>Hace m√°s de 2000 a√±os el cifrador Cesar que desplazaba los caracteres 3 posiciones era casi magia, pero hoy cualquier persona lo puede romper.</li>
          <li>En los a√±os 90's EEUU trato de prohibir la criptografia. Si compart√≠as c√≥digo como el de RSA... ¬°pod√≠as terminar en prisi√≥n!</li>
          <li>No se dice encriptar o desencriptar, sino Cifrar y Descifrar o podria reprobar XD</li>

        </ul>
    </p>
      <br>
  </p>

    <div class="mb-6">
      <h2 class="text-xl font-semibold mb-2">Pasatiempos</h2>
      <div class="grid grid-cols-1 sm:grid-cols-3 gap-4">
        <div class="text-center">
          <img src="hobbit1.jpg" alt="Escribir" class="rounded-lg w-full h-40 object-cover mb-2">
          <p><strong>Calistenia</strong></p>
        </div>
        <div class="text-center">
          <img src="hobbitc.jpg" alt="Ajedrez" class="rounded-lg w-full h-40 object-cover mb-2">
          <p><strong>Beber y aprender del C√°fe</strong></p>
        </div>
        <div class="text-center">
          <img src="hobbit2.jpg" alt="Tecnolog√≠a" class="rounded-lg w-full h-40 object-cover mb-2">
          <p><strong>Destruirme: sufrimiento</strong></p>
        </div>
      </div>
    </div>

    <div class="mb-6">
      <h2 class="text-xl font-semibold mb-2">Contacto</h2>
      <div class="flex justify-center gap-4 text-2xl text-purple-700">
        <a href="mailto:yoss.jmc.y@gmail.com"><i class="fas fa-envelope"></i></a>
        <a href="https://github.com/YossJmc" target="_blank"><i class="fab fa-github"></i></a>
        <a href="https://www.facebook.com/share/16ewPQSBXr/" target="_blank"><i class="fab fa-facebook"></i></a>
        <a href="https://www.instagram.com/yos_tkc?igsh=MWVlNzBiNWhqODh3bw==" target="_blank"><i class="fab fa-instagram"></i></a>
      </div>
    </div>

    <div class="flex flex-col sm:flex-row justify-center gap-4 mt-6">
      <a href="Curriculum_Yos.rar" download class="bg-gray-800 text-white px-6 py-2 rounded hover:bg-blue-800">Descargar CV</a>
      
      <a href="llave_publica.rar" download class="bg-gray-800 text-white px-6 py-2 rounded hover:bg-green-800">Descargar Llave P√∫blica</a>
    </div>
    `;
    break;

          

            case 'rsa':
  main.innerHTML = `
    <h1 class="text-3xl font-bold text-center mb-6">Practica RSA </h1>
    <div class="flex flex-col items-center space-y-4">
    <div class="flex flex-col items-center space-y-4">
  
      <p id="estadoRSA" class="text-center text-green-700 text-sm font-semibold">
        ‚úÖ Llaves generadas correctamente.
      </p>

    <div class="flex flex-col items-center justify-center w-full">  
    <div class="mt-10 w-full max-w-xl space-y-6">

      <h2 class="text-xl font-bold">Alicia: Cifrar archivo</h2>

        <label class="block text-sm text-gray-700">Archivo de texto a cifrar (.txt):</label>
        <input type="file" id="archivoClaro" accept=".txt" class="w-full bg-white border border-gray-300 p-2 rounded" />
        <label class="block text-sm text-gray-700 mt-4">Llave p√∫blica de Betito (.json):</label>
        <input type="file" id="llavePublicaArchivo" accept=".json" class="w-full bg-white border border-gray-300 p-2 rounded" />

        <button onclick="cifrarArchivoRSA()" class="bg-gray-800 hover:bg-blue-800 text-white px-6 py-2 rounded w-full">
          Cifrar
        </button>
      
        <hr class="my-6">
        <h2 class="text-xl text-center font-bold">Betito: Descifrar archivo cifrado</h2>
        <label class="block text-sm text-gray-700">Selecciona el archivo cifrado (.txt):</label>
        <input type="file" id="archivoCifrado" accept=".txt" class="w-full bg-white border border-gray-300 p-2 rounded" />
        <label class="block text-sm text-gray-700">Selecciona la llave privada (.txt):</label>
        <input type="file" id="clavePrivadaBetitoInput" accept=".json" class="w-full bg-white border border-gray-300 p-2 rounded" />

        <button onclick="descifrarArchivoRSA()" class="bg-gray-800 hover:bg-green-800 text-white px-6 py-2 rounded w-full mt-2">
          Descifrar
        </button>
      
        <p id="resultadoDescifrado" class="text-sm text-gray-800 whitespace-pre-wrap mt-4"></p>

      <hr class="my-10">

      <div class="bg-yellow-100 border border-yellow-400 text-yellow-800 p-6 rounded-lg w-full max-w-xl text-center mx-auto shadow-md">
      <h2 class="text-2xl font-bold mb-4">Candy</h2>

        <label class="block text-sm mb-1 text-left">Mensaje (.txt):</label>
        <input type="file" id="archivoFalsoCandy" accept=".txt" class="w-full p-2 border border-gray-300 rounded mb-4">
            
        <label class="block text-sm mb-1 text-left">LLave p√∫blica de Betito (.json):</label>
        <input type="file" id="llavePublicaCandy" accept=".json" class="w-full p-2 border border-gray-300 rounded mb-4">
            
        <button onclick="fabricarMensajeCandy()" class="bg-gray-800 hover:bg-red-700 text-white px-6 py-2 rounded">
          Fabricar mensaje falso
        </button>
      
        <p id="salidaCandyFabricado" class="text-left text-sm font-mono mt-4 whitespace-pre-wrap"></p>
      </div>



    </div>
  </div>

  `
  
  setTimeout(() => {
  const inputClave = document.getElementById("clavePrivadaBetitoInput");
  if (inputClave) {
    inputClave.addEventListener("change", async (e) => {
      const file = e.target.files[0];
      if (!file) return;

      try {
        const text = await file.text();
        const jwk = JSON.parse(text);

        clavePrivadaBetito = await crypto.subtle.importKey(
          "jwk",
          jwk,
          {
            name: "RSA-OAEP",
            hash: "SHA-256"
          },
          false,
          ["decrypt"]
        );

      } catch (e) {
        document.getElementById("resultadoDescifrado").textContent = "Error al cargar la llave privada. Aseg√∫rate de que sea un archivo JSON v√°lido.";
      }
    });
  }
}, 100); // Espera que el DOM est√© listo

;
  break;
  
            case 'rsa_hibrido':        
  main.innerHTML = `

  <div class="flex flex-col items-center justify-center w-full space-y-6 mt-8">
  <h1 class="text-3xl font-bold text-center">Cifrado H√≠brido</h1>
  
  <div class="w-full max-w-xl">
    <label class="block mb-1 text-sm font-semibold">Selecciona un archivo de texto(.txt):</label>
    <input type="file" id="archivoOriginal" accept=".txt" class="w-full p-2 border border-gray-300 rounded" />
  </div>

  <div class="w-full max-w-xl">
    <label class="block mb-1 text-sm font-semibold">Llave p√∫blica del receptor (Betito - .json):</label>
    <input type="file" id="clavePublicaReceptor" accept=".json" class="w-full p-2 border border-gray-300 rounded" />
  </div>

  <div class="w-full max-w-xl">
    <label class="block mb-1 text-sm font-semibold">Llave privada de Alicia (.json):</label>
    <input type="file" id="clavePrivadaAliciaInput" accept=".json" class="w-full p-2 border border-gray-300 rounded" />
  </div>

  <button onclick="hibridoFirmarYCifrar()" class="bg-gray-800 hover:bg-purple-800 text-white px-6 py-2 rounded">
    Firmar y Cifrar
  </button>

  <p id="resultadoHibrido" class="text-center text-sm text-green-700 font-mono"></p>

  </div>

  <hr class="my-10 border-gray-400">

  <h2 class="text-2xl font-bold text-center mb-4">Betito - Validar y Descifrar</h2>
  <div class="w-full max-w-xl mx-auto space-y-4">
  <label class="block text-sm text-gray-700">Archivo cifrado con AES:</label>
  <input type="file" id="archivoCifradoAES" accept=".bin" class="w-full p-2 border border-gray-300 rounded" />
  <label class="block text-sm text-gray-700">LLave AES cifrada (RSA):</label>
  <input type="file" id="claveAESCifrada" accept=".bin" class="w-full p-2 border border-gray-300 rounded" />
  <label class="block text-sm text-gray-700">Firma digital (RSA):</label>
  <input type="file" id="firmaDigitalArchivo" accept=".bin" class="w-full p-2 border border-gray-300 rounded" />
  <label class="block text-sm text-gray-700">Vector Inicial AES:</label>
  <input type="file" id="vectorInicialAES" accept=".bin" class="w-full p-2 border border-gray-300 rounded" />
  <label class="block text-sm text-gray-700">Llave privada de Betito (.json):</label>
  <input type="file" id="clavePrivadaBetitoInput" accept=".json" class="w-full p-2 border border-gray-300 rounded" />
  <label class="block text-sm text-gray-700">Llave p√∫blica de Alicia (.json):</label>
  <input type="file" id="clavePublicaAliciaInput" accept=".json" class="w-full p-2 border border-gray-300 rounded" />

  <button onclick="procesarMensajeHibrido()" class="bg-gray-800 hover:bg-green-800 text-white px-6 py-2 rounded w-full">
    Procesar y verificar mensaje
  </button>

  <pre id="salidaHibrido" class="text-sm text-left bg-white border border-gray-300 rounded p-4 whitespace-pre-wrap"></pre>
  </div>

  ` 

        setTimeout(() => {
  const inputClave = document.getElementById("clavePrivadaAliciaInput");
  if (inputClave) {
    inputClave.addEventListener("change", async (e) => {
      const file = e.target.files[0];
      if (!file) return;

      try {
        const text = await file.text();
        const jwkOriginal = JSON.parse(text);

        const jwkParaFirmar = {
          kty: jwkOriginal.kty,
          n: jwkOriginal.n,
          e: jwkOriginal.e,
          d: jwkOriginal.d,
          p: jwkOriginal.p,
          q: jwkOriginal.q,
          dp: jwkOriginal.dp,
          dq: jwkOriginal.dq,
          qi: jwkOriginal.qi,
          ext: true
        };

        clavePrivadaAlicia = await crypto.subtle.importKey(
          "jwk",
          jwkParaFirmar,
          {
            name: "RSA-PSS",
            hash: "SHA-256"
          },
          false,
          ["sign"]
        );

        
      } catch (error) {
        console.error("Error al importar la clave de Alicia:", error);
        document.getElementById("resultadoHibrido").textContent =
          "Error al cargar la clave privada. Aseg√∫rate de que sea un archivo JSON v√°lido y contenga todos los par√°metros RSA.";
      }
    });
  }
}, 300);

 setTimeout(() => {
  const input = document.getElementById("clavePublicaAliciaInput");
  if (input) {
    input.addEventListener("change", async (e) => {
      const file = e.target.files[0];
      if (!file) return;

      try {
        const text = await file.text();
        const jwkOriginal = JSON.parse(text);

        const jwkParaVerificar = {
          kty: jwkOriginal.kty,
          n: jwkOriginal.n,
          e: jwkOriginal.e,
          ext: true
        };

        clavePublicaAlicia = await crypto.subtle.importKey(
          "jwk",
          jwkParaVerificar,
          {
            name: "RSA-PSS",
            hash: "SHA-256"
          },
          false,
          ["verify"]
        );

        
      } catch (e) {
        console.error("Error al importar la clave p√∫blica:", e);
        alert("Error al cargar la clave p√∫blica. Aseg√∫rate de que sea un archivo JSON v√°lido.");
      }
    });
  }
}, 200);

setTimeout(() => {
  const inputClave = document.getElementById("clavePrivadaBetitoInput");
  if (inputClave) {
    inputClave.addEventListener("change", async (e) => {
      const file = e.target.files[0];
      if (!file) return;

      try {
        const jwk = JSON.parse(await file.text());
        clavePrivadaBetito = await crypto.subtle.importKey(
          "jwk",
          jwk,
          {
            name: "RSA-OAEP",
            hash: "SHA-256"
          },
          false,
          ["decrypt"]
        );
        
      } catch (e) {
        console.error("Error al importar la clave de Betito (h√≠brido):", e);
        document.getElementById("salidaHibrido").textContent += "\nError al cargar la clave privada. Verifica el archivo.";
      }
    });
  }
}, 500);
;
            break;

        }
      }

let clavePrivadaBetito = null;
let clavePublicaBetito = null;
let clavePrivadaAlicia = null;
let clavePublicaAlicia = null;


fetch('llaves/betito_llave_publica.json')
  .then(res => res.json())
  .then(async jwk => {
    clavePublicaBetito = await crypto.subtle.importKey(
      "jwk",
      jwk,
      { name: "RSA-OAEP", hash: "SHA-256" },
      false,
      ["encrypt"]
    );
    console.log("Clave p√∫blica de Betito cargada.");
  });

async function cifrarArchivoRSA() {
  const inputTexto = document.getElementById("archivoClaro");
  const inputLlave = document.getElementById("llavePublicaArchivo");

  if (!inputTexto.files.length || !inputLlave.files.length) {
    return;
  }

  const textoPlano = await inputTexto.files[0].text();

  const jwkJson = await inputLlave.files[0].text();
  let jwk;
  try {
    jwk = JSON.parse(jwkJson);
  } catch (err) {
    alert("La clave p√∫blica no es un JSON v√°lido.");
    return;
  }

  const clavePublicaImportada = await crypto.subtle.importKey(
    "jwk",
    jwk,
    {
      name: "RSA-OAEP",
      hash: "SHA-256"
    },
    false,
    ["encrypt"]
  );

  const encoder = new TextEncoder();
  const datos = encoder.encode(textoPlano);

  const cifrado = await crypto.subtle.encrypt(
    {
      name: "RSA-OAEP"
    },
    clavePublicaImportada,
    datos
  );

  const base64 = btoa(String.fromCharCode(...new Uint8Array(cifrado)));

  const blob = new Blob([base64], { type: "text/plain" });
  const url = URL.createObjectURL(blob);
  const a = document.createElement("a");
  a.href = url;
  a.download = "archivo_cifrado.txt";
  a.click();
  URL.revokeObjectURL(url);
}

async function descifrarArchivoRSA() {
  const archivo = document.getElementById("archivoCifrado").files[0];
  const salida = document.getElementById("resultadoDescifrado");

  if (!archivo) {
    salida.textContent = "No has subido ning√∫n archivo cifrado.";
    return;
  }

  if (!clavePrivadaBetito) {
    salida.textContent = "A√∫n no has cargado tu clave privada.";
    return;
  }

  try {
    const base64 = await archivo.text();
    const bin = atob(base64.trim());
    const textoCifrado = new Uint8Array([...bin].map(c => c.charCodeAt(0)));

    const descifrado = await crypto.subtle.decrypt(
      { name: "RSA-OAEP" },
      clavePrivadaBetito,
      textoCifrado
    );

    const mensaje = new TextDecoder().decode(descifrado);
    salida.textContent = `Texto descifrado:\n\n${mensaje}`;
  } catch (e) {
    console.error("Error al descifrar:", e);
    salida.textContent = "Error al descifrar el mensaje. Verifica el archivo o la clave.";
  }
}


let clavePrivadaCandy = null;
let clavePublicaCandy = null;

async function fabricarMensajeCandy() {
  const archivo = document.getElementById("archivoFalsoCandy");
  const clave = document.getElementById("llavePublicaCandy");
  const salida = document.getElementById("salidaCandyFabricado");

  if (!archivo.files.length || !clave.files.length) {
    salida.textContent = "Debes seleccionar un archivo falso y la clave p√∫blica de Betito.";
    return;
  }

  const mensaje = await archivo.files[0].text();
  const jwkJson = await clave.files[0].text();

  let jwk;
  try {
    jwk = JSON.parse(jwkJson);
  } catch (err) {
    salida.textContent = "La llave p√∫blica no es un JSON v√°lido.";
    return;
  }

  try {
    const clavePublicaImportada = await crypto.subtle.importKey(
      "jwk",
      jwk,
      {
        name: "RSA-OAEP",
        hash: "SHA-256"
      },
      false,
      ["encrypt"]
    );

    const datos = new TextEncoder().encode(mensaje);
    const cifrado = await crypto.subtle.encrypt(
      { name: "RSA-OAEP" },
      clavePublicaImportada,
      datos
    );

    const base64 = btoa(String.fromCharCode(...new Uint8Array(cifrado)));

    const blob = new Blob([base64], { type: "text/plain" });
    const url = URL.createObjectURL(blob);
    const a = document.createElement("a");
    a.href = url;
    a.download = "mensaje_falso_candy.txt";
    a.click();
    URL.revokeObjectURL(url);

    salida.textContent = "Mensaje falso cifrado";
  } catch (err) {
    salida.textContent = "No se pudo cifrar el mensaje falso.";
  }
}

async function mensajeFalsoDeCandy() {
  const salida = document.getElementById("salidaCandyFalsa");

  if (!clavePublicaBetito || !clavePrivadaBetito) {
    salida.textContent = "Necesitas generar primero tus llaves RSA.";
    return;
  }


  const mensajeFalso = `El examen fue cancelado, ya no es necesario entregar nada.\natte.\nAlicia`;

  const encoder = new TextEncoder();
  const datos = encoder.encode(mensajeFalso);

  const cifrado = await crypto.subtle.encrypt(
    { name: "RSA-OAEP" },
    clavePublicaBetito,
    datos
  );

  try {
    const descifrado = await crypto.subtle.decrypt(
      { name: "RSA-OAEP" },
      clavePrivadaBetito,
      cifrado
    );

    const mensaje = new TextDecoder().decode(descifrado);

    salida.textContent = `Mensaje recibido:\n\n${mensaje}\n\nPero... ¬ørealmente lo mand√≥ Alicia?\nNo hay forma de verificarlo sin una firma digital. Este mensaje fue falsificado por Candy.`;
  } catch (e) {
    salida.textContent = "No se pudo descifrar el mensaje falso.";
  }
}

async function hibridoFirmarYCifrar() {
  const archivoInput = document.getElementById("archivoOriginal");
  const claveInput = document.getElementById("clavePublicaReceptor");
  const salida = document.getElementById("resultadoHibrido");

  if (!archivoInput.files.length || !claveInput.files.length) {
    salida.textContent = "Faltan archivos: selecciona el original y la clave p√∫blica del receptor.";
    return;
  }

  const archivoTexto = await archivoInput.files[0].text();
  const jwkPublicaJSON = await claveInput.files[0].text();

  let clavePublica;
  try {
    clavePublica = await crypto.subtle.importKey(
      "jwk", JSON.parse(jwkPublicaJSON),
      { name: "RSA-OAEP", hash: "SHA-256" },
      false, ["encrypt"]
    );
  } catch {
    salida.textContent = "Error: Clave p√∫blica inv√°lida.";
    return;
  }

  // 1. Generar clave AES aleatoria
  const claveAES = crypto.getRandomValues(new Uint8Array(32));
  const iv = crypto.getRandomValues(new Uint8Array(12)); 

  // 2. Cifrar archivo original con AES-GCM
  const cifradoAES = await crypto.subtle.encrypt(
    { name: "AES-GCM", iv },
    await crypto.subtle.importKey("raw", claveAES, "AES-GCM", false, ["encrypt"]),
    new TextEncoder().encode(archivoTexto)
  );

  // 3. Calcular hash SHA-256
  const hash = await crypto.subtle.digest("SHA-256", new TextEncoder().encode(archivoTexto));

  // 4. Firmar hash con clave privada de ALICIA (simulada)
  if (!clavePrivadaAlicia) {
    salida.textContent = "Falta clave privada de Alicia para firmar.";
    return;
  }
  const firma = await crypto.subtle.sign(
    { name: "RSA-PSS", saltLength: 32 },
    clavePrivadaAlicia,
    hash
  );

  // 5. Cifrar clave AES con clave p√∫blica del receptor
  const claveAEScifrada = await crypto.subtle.encrypt(
    { name: "RSA-OAEP" },
    clavePublica,
    claveAES
  );

  // 6. Descargar archivos
  const descargar = (data, nombre) => {
    const blob = new Blob([data], { type: "application/octet-stream" });
    const a = document.createElement("a");
    a.href = URL.createObjectURL(blob);
    a.download = nombre;
    a.click();
    URL.revokeObjectURL(a.href);
  };

  descargar(new Uint8Array(cifradoAES), "documento_cifrado_aes.bin");
  descargar(claveAEScifrada, "clave_aes_cifrada_rsa.bin");
  descargar(firma, "firma_digital.bin");
  descargar(iv, "vector_inicial_aes.bin");

  salida.textContent = "Todo cifrado y firmado.";
}

async function procesarMensajeHibrido() {
  const salida = document.getElementById("salidaHibrido");
  salida.textContent = "Procesando...";

  const archivoAES = document.getElementById("archivoCifradoAES").files[0];
  const archivoClave = document.getElementById("claveAESCifrada").files[0];
  const archivoFirma = document.getElementById("firmaDigitalArchivo").files[0];
  const archivoIV = document.getElementById("vectorInicialAES").files[0];

  if (!archivoAES || !archivoClave || !archivoFirma || !archivoIV) {
    salida.textContent = "Faltan uno o m√°s archivos.";
    return;
  }

  if (!clavePrivadaBetito || !clavePublicaAlicia) {
    salida.textContent = "Debes tener tus claves RSA generadas y la clave p√∫blica de Alicia cargada.";
    return;
  }

  try {
    // Leer archivos binarios
    const [aesData, claveCifrada, firma, iv] = await Promise.all([
      archivoAES.arrayBuffer(),
      archivoClave.arrayBuffer(),
      archivoFirma.arrayBuffer(),
      archivoIV.arrayBuffer()
    ]);

    // 1. Betito descifra la clave AES con su clave privada
    const claveAES = await crypto.subtle.decrypt(
      { name: "RSA-OAEP" },
      clavePrivadaBetito,
      claveCifrada
    );

    // 2. Descifra el mensaje con AES
    const mensajeClaro = await crypto.subtle.decrypt(
  {
    name: "AES-GCM",  
    iv: new Uint8Array(iv)
  },
  await crypto.subtle.importKey("raw", claveAES, "AES-GCM", false, ["decrypt"]),
  aesData
);

    const mensaje = new TextDecoder().decode(mensajeClaro);

    // 3. Genera el hash y verifica firma
    const hash = await crypto.subtle.digest("SHA-256", mensajeClaro);
    const firmaOk = await crypto.subtle.verify(
      { name: "RSA-PSS", saltLength: 32 },
      clavePublicaAlicia,
      firma,
      hash
    );

    // 4. Mostrar resultado
    salida.textContent = `Mensaje descifrado:\n\n${mensaje}\n\nFirma v√°lida: ${firmaOk ? "S√≠, autenticado " : "No, posible alteraci√≥n "}`;
  } catch (e) {
    salida.textContent = "Error al procesar el mensaje. Puede que las claves no coincidan o los archivos est√©n da√±ados.";
  }
}
      // secci√≥n predeterminada
      loadContent('clasica');
    </script>
    <script>import {
  getAuth,
  onAuthStateChanged
} from "https://www.gstatic.com/firebasejs/11.9.1/firebase-auth.js";

import {
  getFirestore,
  doc,
  getDoc
} from "https://www.gstatic.com/firebasejs/11.9.1/firebase-firestore.js";

const auth = getAuth();
const db = getFirestore();

onAuthStateChanged(auth, async (user) => {
  if (user) {
    const ref = doc(db, "usuarios", user.uid);
    const docSnap = await getDoc(ref);

    const name = docSnap.exists() ? docSnap.data().nombre : user.email;
    const titulo = document.getElementById("bienvenidaUsuario");
    if (titulo) titulo.textContent = `Bienvenido: ${name}`;
  }
});

document.getElementById("clavePrivadaBetitoInput").addEventListener("change", async (e) => {
  const file = e.target.files[0];
  if (!file) return;

  try {
    const text = await file.text();
    const jwk = JSON.parse(text);

    clavePrivadaBetito = await crypto.subtle.importKey(
      "jwk",
      jwk,
      {
        name: "RSA-OAEP",
        hash: "SHA-256"
      },
      false,
      ["decrypt"]
    );

    console.log("Clave privada cargada correctamente.");
    document.getElementById("resultadoDescifrado").textContent = "Clave privada cargada correctamente.";
  } catch (e) {
    console.error("Error al importar la clave:", e);
    document.getElementById("resultadoDescifrado").textContent = " Error al cargar la clave privada. Aseg√∫rate de que sea un archivo JSON v√°lido.";
  }
});

</script>
  </body>
  </html>
